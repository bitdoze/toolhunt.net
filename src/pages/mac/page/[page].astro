---
import { getCollection } from 'astro:content';
import SectionLayout from '../../../layouts/SectionLayout.astro';

export async function getStaticPaths({ paginate }) {
  const allTools = await getCollection('mac');
  const sortedTools = allTools.sort((a, b) => 
    b.data.publishedDate.getTime() - a.data.publishedDate.getTime()
  );
  return paginate(sortedTools, { pageSize: 12 });
}

const { page } = Astro.props;
const url = new URL(Astro.request.url);

// Get unique categories
const categories = [...new Set(page.data.map(tool => tool.data.category))];

// Get unique pricing options
const pricingOptions = ['Free', 'Paid', 'Freemium'];

// Filter tools based on URL parameters
const query = url.searchParams.get('q')?.toLowerCase() || '';
const selectedCategories = url.searchParams.getAll('category');
const selectedPricing = url.searchParams.getAll('pricing');

let filteredTools = page.data;

// Apply search filter
if (query) {
  filteredTools = filteredTools.filter(tool => 
    tool.data.title.toLowerCase().includes(query) ||
    tool.data.description.toLowerCase().includes(query)
  );
}

// Apply category filter
if (selectedCategories.length > 0) {
  filteredTools = filteredTools.filter(tool => 
    selectedCategories.includes(tool.data.category)
  );
}

// Apply pricing filter
if (selectedPricing.length > 0) {
  filteredTools = filteredTools.filter(tool => 
    selectedPricing.includes(tool.data.pricing)
  );
}
---

<SectionLayout
  title="Collection with FREE Mac Apps and Tools"
  description="Discover the best Mac applications for productivity, development, and creativity that will help you with your work"
  tools={filteredTools}
  categories={categories}
  pricingOptions={pricingOptions}
  showPricing={true}
  currentPage={page.currentPage}
  totalPages={page.lastPage}
  section="mac"
/>